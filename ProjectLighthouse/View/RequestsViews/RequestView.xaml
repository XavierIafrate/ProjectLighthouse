<UserControl x:Class="ProjectLighthouse.View.RequestView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:uc="clr-namespace:ProjectLighthouse.View.UserControls"
             xmlns:vm="clr-namespace:ProjectLighthouse.ViewModel"
             xmlns:local="clr-namespace:ProjectLighthouse.View"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             MaxHeight="1000"
             Background="{StaticResource materialBackground}">

    <UserControl.Resources>
        <ResourceDictionary>
            <Style x:Key="ApproveButton" TargetType="Button">
                <Setter Property="Background" Value="{StaticResource gradGood}"/>
                <Setter Property="FontFamily" Value="/Resources/Font/#Proxima Nova"/>
                <Setter Property="Foreground" Value="White"/>
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="HorizontalAlignment" Value="Right"/>
                <Setter Property="Height" Value="28"/>
                <Setter Property="Width" Value="100"/>
                <Setter Property="FontWeight" Value="Bold"/>
                <Setter Property="Margin" Value="0,5"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}"
                                CornerRadius="14,0,0,14"
                                Height="28"
                                BorderThickness="0"
                                Padding="20,0">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="{StaticResource materialPrimaryGreen}"/>
                        <Setter Property="Foreground" Value="White"/>
                    </Trigger>
                </Style.Triggers>
            </Style>
            
            <Style x:Key="DeclineButton" TargetType="Button">
                <Setter Property="Background" Value="{StaticResource materialError}"/>
                <Setter Property="FontFamily" Value="/Resources/Font/#Proxima Nova"/>
                <Setter Property="Foreground" Value="{StaticResource materialOnError}"/>
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="HorizontalAlignment" Value="Left"/>
                <Setter Property="Height" Value="28"/>
                <Setter Property="Width" Value="100"/>
                <Setter Property="FontWeight" Value="Bold"/>
                <Setter Property="Margin" Value="0,5"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}"
                                CornerRadius="0,14,14,0"
                                Height="28"
                                BorderThickness="0"
                                Padding="20,0">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="{StaticResource materialErrorVar}"/>
                    </Trigger>
                </Style.Triggers>
            </Style>
            <!--<vm:RequestViewModel x:Key="vm"/>-->
        </ResourceDictionary>
    </UserControl.Resources>
    <!--DataContext="{StaticResource vm}"-->
    
    
    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"
                              MinWidth="340"/>
            <ColumnDefinition Width="20"/>
            <ColumnDefinition Width="2*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="auto"/>
        </Grid.RowDefinitions>


        <ListView ItemsSource="{Binding FilteredRequests, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                  HorizontalContentAlignment="Stretch"
                  SelectedItem="{Binding SelectedRequest, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                  ScrollViewer.CanContentScroll="false"
                  x:Name="requests_ListView"
                  SelectionChanged="requests_ListView_SelectionChanged">
            <ListView.ItemTemplate>
                <DataTemplate>
                    <uc:DisplayRequest Request="{Binding}"/>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <StatusBar HorizontalAlignment="Right"
                   Background="Transparent"
                   Margin="0,5,0,0"
                   Grid.Row="1">
            <TextBlock Text="{Binding FilteredRequests.Count, StringFormat='{}{0} request(s)'}"/>
            <Separator Margin="5,0" Background="LightGray"/>
            <TextBlock Text="Filter by:" 
                       VerticalAlignment="Center"
                       Margin="0,0,10,0"/>
            <ComboBox Width="100" x:Name="filterComboBox" Text="{Binding SelectedFilter, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                <ComboBoxItem Content="Last 14 Days" IsSelected="True"/>
                <ComboBoxItem Content="My Requests"/>
                <ComboBoxItem Content="Pending"/>
                <ComboBoxItem Content="Accepted"/>
                <ComboBoxItem Content="Declined"/>
                <ComboBoxItem Content="All"/>
            </ComboBox>
            <Button Content="CSV" Command="{Binding ExportCommand}" Style="{StaticResource ButtonTemplate}" Margin="0"/>
        </StatusBar>
        <StackPanel Grid.Column="2"
                    VerticalAlignment="Center">
            <TextBlock Text="none found :(" 
                       Grid.Column="2" 
                       HorizontalAlignment="Center" 
                       FontSize="30" 
                       Foreground="#dddddd" 
                       Visibility="{Binding NothingVis, UpdateSourceTrigger=PropertyChanged}"/>
            <TextBlock Text="try changing the filter" 
                       Grid.Column="2" 
                       HorizontalAlignment="Center" 
                       FontSize="20"
                       FontStyle="Italic"
                       Foreground="#dddddd" 
                       Visibility="{Binding NothingVis, UpdateSourceTrigger=PropertyChanged}"/>
        </StackPanel>
        <ScrollViewer Grid.Column="2"
                      Grid.RowSpan="2"
                      VerticalScrollBarVisibility="Hidden"
                      MaxWidth="700">
            <Grid Visibility="{Binding CardVis, UpdateSourceTrigger=PropertyChanged}" Margin="20,10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Rectangle RadiusX="10" RadiusY="10">
                    <Rectangle.Effect>
                        <DropShadowEffect BlurRadius="15" Direction="220" RenderingBias="Quality" ShadowDepth="5" Color="#FF000000" Opacity="0.3"/>
                    </Rectangle.Effect>
                    <Rectangle.Fill>
                        <SolidColorBrush Color="White"/>
                    </Rectangle.Fill>
                </Rectangle>

                <StackPanel Margin="10">
                    <!--Card Header-->
                    <Grid DataContext="{Binding}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="auto"/>
                            <RowDefinition Height="auto"/>
                            <RowDefinition Height="auto"/>
                            <RowDefinition Height="auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Text="{Binding SelectedRequest.Product, UpdateSourceTrigger=PropertyChanged, FallbackValue='P0XXX.123-456-A2'}"
                                   Style="{StaticResource heroTextStyle}"
                                   Grid.ColumnSpan="2"/>

                        <Grid Grid.Row="1">
                            <Rectangle Fill="{StaticResource materialPrimary}" RadiusX="5" RadiusY="5"/>
                            <TextBlock Text="{Binding SelectedRequest.QuantityRequired, StringFormat='{}{0:#,##0} pcs required', FallbackValue='0 pcs required'}"
                                       x:Name = "requiredQtyTextBlock"
                                       FontSize="18"
                                       Margin="10,3,10,5"
                                       Foreground="{StaticResource materialOnPrimary}"/>
                        </Grid>

                        <TextBlock Text="{Binding SelectedRequest.DateRequired, StringFormat='{}Required for {0:dd/MM/yy}', FallbackValue='Required for 01/01/1970'}"
                                   x:Name = "dateRequiredTextBlock"
                                   Grid.Row="2"
                                   Grid.ColumnSpan="2"
                                   Style="{StaticResource subtitleTextStyle}"/>
                    </Grid>

                    <!--MetaData Dates display grid-->
                    <Separator Margin="0,5"/>
                    <Grid Margin="5,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="auto"/>
                            <RowDefinition Height="auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Text="{Binding SelectedRequest.RaisedBy, UpdateSourceTrigger=PropertyChanged, StringFormat='{}Raised by {0}', FallbackValue='Raised by Randy Marsh'}"
                                   Style="{StaticResource accentTextStyle}"/>
                        <TextBlock Text="{Binding SelectedRequest.DateRaised, UpdateSourceTrigger=PropertyChanged, StringFormat='{}{0:dd/MM/yy HH:mm}', FallbackValue='01/01/1970 23:59'}"
                                   Grid.Column="2"
                                   HorizontalAlignment="Right"
                                   Style="{StaticResource accentTextStyle}"/>

                        <TextBlock Text="{Binding SelectedRequest.ModifiedBy, UpdateSourceTrigger=PropertyChanged, StringFormat='{}Updated by {0}', FallbackValue='Updated by Kyle Brovloski'}"
                                   Visibility="{Binding ModifiedVis, UpdateSourceTrigger=PropertyChanged}"
                                   Style="{StaticResource accentTextStyle}"
                                   Grid.Row="1"/>
                        <TextBlock Text="{Binding SelectedRequest.LastModified, UpdateSourceTrigger=PropertyChanged, StringFormat='{}{0:dd/MM/yy HH:mm}', FallbackValue='01/01/1970 23:59'}"
                                   Visibility="{Binding ModifiedVis, UpdateSourceTrigger=PropertyChanged}"
                                   Style="{StaticResource accentTextStyle}"
                                   HorizontalAlignment="Right"
                                   Grid.Column="2"
                                   Grid.Row="1"/>
                    </Grid>

                    <!--Controls area-->
                    <Separator Margin="0,5"/>
                    <TextBlock Text="Decision Making"
                               Style="{StaticResource subtitleTextStyle}"
                               Visibility="{Binding DecisionVis}"/>

                    <StackPanel Margin="10,0"
                                Visibility="{Binding DecisionVis}">

                        <CheckBox Content="Scheduling Approval"
                                  IsChecked="{Binding SelectedRequest.isSchedulingApproved, UpdateSourceTrigger=PropertyChanged}"
                                  IsEnabled="{Binding SchedulingCheckboxEnabled,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  Click="CheckBox_Click"
                                  Margin="10,5,0,5" />
                        <CheckBox Content="Production Approval" 
                                  IsChecked="{Binding SelectedRequest.isProductionApproved, UpdateSourceTrigger=PropertyChanged}"
                                  IsEnabled="{Binding ProductionCheckboxEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  Click="CheckBox_Click"
                                  Margin="10,5" />
                        <TextBlock Text="Reason for declining:" 
                                   Style="{StaticResource accentTextStyle}"
                                   Grid.Row="2"/>
                        <ComboBox Margin="0,0,0,5" 
                                  x:Name="DeclineComboBox" 
                                  Text="{Binding SelectedRequest.DeclinedReason, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                  IsEnabled="{Binding DropboxEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                            <ComboBoxItem Content="Uneconomical"/>
                            <ComboBoxItem Content="Below MOQ"/>
                            <ComboBoxItem Content="Cannot deliver on time"/>
                            <ComboBoxItem Content="Machining not possible"/>
                            <ComboBoxItem Content="Duplicate request"/>
                        </ComboBox>

                        <Grid x:Name="approvalControls"
                              Visibility="{Binding ApprovalControlsVis, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="auto"/>
                                <RowDefinition Height="5"/>
                                <RowDefinition Height="auto"/>
                                <RowDefinition Height="auto"/>
                            </Grid.RowDefinitions>
                            <Button Content="Decline"
                                    x:Name="DeclineButton"
                                    Command="{Binding DeclineCommand}"
                                    Style="{StaticResource CancelButtonTemplate}"/>
                            <Button Content="Approve" 
                                    Grid.Column="1"
                                    x:Name="ApproveButton"
                                    Command="{Binding ApproveCommand}"
                                    Style="{StaticResource GreenButtonTemplate}"/>
                            
                        </Grid>
                    </StackPanel>
                    <Grid Margin="10" Visibility="{Binding ApprovedVis, FallbackValue=Collapsed}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Rectangle Fill="{StaticResource materialPrimaryGreen}"
                                   RadiusX="5"
                                   RadiusY="5"/>
                        <TextBlock Text="APPROVED"
                                   FontWeight="SemiBold"
                                   FontSize="16"
                                   Foreground="{StaticResource materialOnPrimary}"
                                   Padding="10,5"/>
                    </Grid>
                    
                    <StackPanel Margin="10,0"
                                Visibility="{Binding ApprovedVis, FallbackValue=Collapsed}">
                        <TextBlock Text="This request has been approved for manufacture."
                                   Style="{StaticResource bodyTextStyle}"/>
                        <TextBlock Text="Please enter the Purchase Order reference here:"
                                   Style="{StaticResource bodyTextStyle}"
                                   Padding="0,5,0,4"/>
                        <TextBox BorderBrush="{StaticResource materialPrimary}" 
                                 Text="{Binding PurchaseRef, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                            <TextBox.Style>
                                <Style TargetType="TextBox">
                                    <Setter Property="Padding" Value="2"/>
                                    <Setter Property="FontSize" Value="16"/>
                                </Style>
                            </TextBox.Style>
                        </TextBox>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="auto"/>
                            </Grid.ColumnDefinitions>
                            <Button Style="{StaticResource ButtonTemplate}"
                                    Command="{Binding UpdateOrderCommand}"
                                    IsEnabled="{Binding UpdateButtonEnabled, UpdateSourceTrigger=PropertyChanged}"
                                    Content="Update Order"
                                    Grid.Column="1"/>
                        </Grid>
                    </StackPanel>

                    <Grid Margin="10" Visibility="{Binding DeclinedVis, FallbackValue=Collapsed}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Rectangle Fill="{StaticResource materialError}"
                                   RadiusX="5"
                                   RadiusY="5"/>
                        <TextBlock Text="DECLINED"
                                   FontWeight="SemiBold"
                                   FontSize="16"
                                   Foreground="{StaticResource materialOnError}"
                                   Padding="10,5"/>
                    </Grid>
                    <StackPanel Margin="10,0"
                                Visibility="{Binding DeclinedVis, FallbackValue=Collapsed}">
                        <TextBlock Text="Unfortunately this request has been declined, citing the reason below."
                                   Style="{StaticResource bodyTextStyle}"
                                   Foreground="{StaticResource materialError}"/>
                    </StackPanel>

                    <Separator Margin="0,5"/>

                    <StackPanel Grid.Row="2"
                                Margin="10"
                                Visibility="{Binding EditControlsVis, UpdateSourceTrigger=PropertyChanged, Mode=OneWay}">
                        <TextBlock Text="Edit Request"
                                   Style="{StaticResource subtitleTextStyle}"/>
                        <TextBlock Text="Quantity Required"
                               Style="{StaticResource subsubtitleTextStyle}"/>
                        <TextBox x:Name="quantityTextbox"
                                 Text="{Binding SelectedRequest.QuantityRequired, Mode=OneWay}"
                                 IsEnabled="{Binding CanEditRequirements, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}"/>

                        <TextBlock Text="Date Required"
                               Style="{StaticResource subsubtitleTextStyle}"/>
                        <DatePicker SelectedDate="{Binding SelectedRequest.DateRequired, Mode=TwoWay}" 
                                    DisplayDateStart="{x:Static sys:DateTime.Now}"
                                    IsEnabled="{Binding CanEditRequirements, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}"/>

                        <TextBlock Text="Notes"
                               Style="{StaticResource subsubtitleTextStyle}"/>
                        <RichTextBox x:Name="notesTextBox"
                                    MinHeight="50"
                                    BorderBrush="{StaticResource materialPrimary}"
                                    BorderThickness="2">
                            <FlowDocument LineHeight="2"/>
                        </RichTextBox>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Style="{StaticResource ButtonTemplate}"
                                    Content="Save"
                                    x:Name="saveChangesButton"
                                    Click="saveChangesButton_Click"/>
                        </StackPanel>
                    </StackPanel>
                    <TextBlock Text="{Binding SelectedRequest.Status, StringFormat='{}Status: {0}', FallbackValue='Status: Pending input'}"/>
                </StackPanel>

            </Grid>

        </ScrollViewer>
    </Grid>
</UserControl>
