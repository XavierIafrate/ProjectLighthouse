<UserControl
    x:Class="ProjectLighthouse.View.RequestView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:ProjectLighthouse.View"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:uc="clr-namespace:ProjectLighthouse.View.UserControls"
    xmlns:vm="clr-namespace:ProjectLighthouse.ViewModel"
    Background="{StaticResource materialBackground}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="350" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="auto" />
        </Grid.RowDefinitions>


        <ListView
            x:Name="requests_ListView"
            HorizontalContentAlignment="Stretch"
            ItemsSource="{Binding FilteredRequests, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
            ScrollViewer.CanContentScroll="false"
            SelectedItem="{Binding SelectedRequest, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
            SelectionChanged="requests_ListView_SelectionChanged">
            <ListView.ItemTemplate>
                <DataTemplate>
                    <uc:DisplayRequest Request="{Binding}" />
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <StatusBar
            Grid.Row="1"
            Margin="0,5,0,0"
            HorizontalAlignment="Right"
            Background="Transparent">
            <TextBlock Text="{Binding FilteredRequests.Count, StringFormat='{}{0} request(s)', FallbackValue='10 request(s)'}" />
            <Separator Margin="5,0" Background="LightGray" />
            <TextBlock
                Margin="0,0,10,0"
                VerticalAlignment="Center"
                Text="Filter by:" />
            <ComboBox x:Name="filterComboBox" Text="{Binding SelectedFilter, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                <ComboBoxItem Content="Last 14 Days" IsSelected="True" />
                <ComboBoxItem Content="My Requests" />
                <ComboBoxItem Content="Pending" />
                <ComboBoxItem Content="Accepted" />
                <ComboBoxItem Content="Declined" />
                <ComboBoxItem Content="All" />
            </ComboBox>
            <!--<Button
                Command="{Binding ExportCommand}"
                Style="{StaticResource CSVButton}"/>-->
        </StatusBar>
        <StackPanel Grid.Column="2" VerticalAlignment="Center">
            <TextBlock
                Grid.Column="2"
                HorizontalAlignment="Center"
                FontSize="30"
                Foreground="#dddddd"
                Text="none found :("
                Visibility="{Binding NothingVis, UpdateSourceTrigger=PropertyChanged}" />
            <TextBlock
                Grid.Column="2"
                HorizontalAlignment="Center"
                FontSize="20"
                FontStyle="Italic"
                Foreground="#dddddd"
                Text="try changing the filter"
                Visibility="{Binding NothingVis, UpdateSourceTrigger=PropertyChanged}" />
        </StackPanel>
        <ScrollViewer Grid.RowSpan="2" Grid.Column="2">
            <Grid
                MaxWidth="700"
                Margin="20,10"
                Visibility="{Binding CardVis, UpdateSourceTrigger=PropertyChanged}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Rectangle
                    RadiusX="5"
                    RadiusY="5"
                    Stroke="{StaticResource materialPrimaryBlue}"
                    StrokeThickness="2" />

                <StackPanel Margin="20">
                    <!--  Card Header  -->

                    <StackPanel Margin="0,0,0,10">
                        <TextBlock Style="{StaticResource title}" Text="{Binding SelectedRequest.Product, FallbackValue='P0XXX.123-456-A2'}" />

                        <StackPanel Orientation="Horizontal">
                            <TextBlock Style="{StaticResource subtitle}" Text="{Binding SelectedRequest.QuantityRequired, StringFormat='{}{0:#,##0} pcs required', FallbackValue='0 pcs required'}" />
                            <TextBlock
                                x:Name="dateRequiredTextBlock"
                                Style="{StaticResource subtitle}"
                                Text="{Binding SelectedRequest.DateRequired, StringFormat='{} for {0:dd/MM/yy}', FallbackValue=' for 01/01/1970'}" />

                        </StackPanel>
                    </StackPanel>


                    <!--  MetaData Dates display grid  -->
                    <Separator Margin="0,5" />
                    <Grid Margin="15,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="auto" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="auto" />
                            <RowDefinition Height="auto" />
                        </Grid.RowDefinitions>
                        <TextBlock FontStyle="Italic" Text="{Binding SelectedRequest.RaisedBy, UpdateSourceTrigger=PropertyChanged, StringFormat='{}Raised by {0}', FallbackValue='Raised by Randy Marsh'}" />
                        <TextBlock
                            Grid.Column="2"
                            HorizontalAlignment="Right"
                            FontStyle="Italic"
                            Text="{Binding SelectedRequest.DateRaised, UpdateSourceTrigger=PropertyChanged, StringFormat='{}{0:dd/MM/yy HH:mm}', FallbackValue='01/01/1970 23:59'}" />

                        <TextBlock
                            Grid.Row="1"
                            FontStyle="Italic"
                            Text="{Binding SelectedRequest.ModifiedBy, UpdateSourceTrigger=PropertyChanged, StringFormat='{}Updated by {0}', FallbackValue='Updated by Kyle Brovloski'}"
                            Visibility="{Binding ModifiedVis, UpdateSourceTrigger=PropertyChanged}" />
                        <TextBlock
                            Grid.Row="1"
                            Grid.Column="2"
                            HorizontalAlignment="Right"
                            FontStyle="Italic"
                            Text="{Binding SelectedRequest.LastModified, UpdateSourceTrigger=PropertyChanged, StringFormat='{}{0:dd/MM/yy HH:mm}', FallbackValue='01/01/1970 23:59'}"
                            Visibility="{Binding ModifiedVis, UpdateSourceTrigger=PropertyChanged}" />
                    </Grid>

                    <!--  Controls area  -->
                    <Separator Margin="0,5" />
                    <TextBlock
                        Margin="0,15,0,0"
                        Style="{StaticResource section}"
                        Text="Approval Controls"
                        Visibility="{Binding DecisionVis}" />

                    <StackPanel Margin="10,0" Visibility="{Binding DecisionVis}">
                        <TextBlock
                            Grid.Row="2"
                            Margin="0,10,0,5"
                            HorizontalAlignment="Center"
                            FontStyle="Italic"
                            Text="Reason for declining:" />
                        <ComboBox
                            x:Name="DeclineComboBox"
                            MaxWidth="300"
                            Margin="0,0,0,5"
                            IsEnabled="{Binding DropboxEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            Text="{Binding SelectedRequest.DeclinedReason, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}">
                            <ComboBoxItem Content="Uneconomical" />
                            <ComboBoxItem Content="Below MOQ" />
                            <ComboBoxItem Content="Cannot deliver on time" />
                            <ComboBoxItem Content="Machining not possible" />
                            <ComboBoxItem Content="Duplicate request" />
                        </ComboBox>

                        <Grid
                            x:Name="approvalControls"
                            Margin="0,20"
                            HorizontalAlignment="Center"
                            Visibility="{Binding ApprovalControlsVis, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition Width="auto" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="auto" />
                                <RowDefinition Height="5" />
                                <RowDefinition Height="auto" />
                                <RowDefinition Height="auto" />
                            </Grid.RowDefinitions>
                            <Button
                                x:Name="DeclineButton"
                                Margin="10,0"
                                Command="{Binding DeclineCommand}"
                                Style="{StaticResource DeclineButton}" />
                            <Button
                                x:Name="ApproveButton"
                                Grid.Column="1"
                                Margin="10,0"
                                Command="{Binding ApproveCommand}"
                                Style="{StaticResource ApproveButton}" />

                        </Grid>
                    </StackPanel>
                    <Grid Margin="10" Visibility="{Binding ApprovedVis, FallbackValue=Visible}">
                        <Rectangle Fill="{StaticResource materialPrimaryGreen}" />
                        <TextBlock
                            Padding="10,5"
                            HorizontalAlignment="Center"
                            FontSize="16"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource materialOnPrimary}"
                            Text="Approved" />
                    </Grid>

                    <StackPanel Margin="10,0" Visibility="{Binding ApprovedVis, FallbackValue=Visible}">
                        <TextBlock Text="This request has been approved for manufacture." />
                        <TextBlock Padding="0,5,0,4" Text="Please enter the Purchase Order reference here:" />
                        <TextBox Text="{Binding PurchaseRef, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource UsernameTextBox}"/>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="auto" />
                            </Grid.ColumnDefinitions>
                            <Button
                                Grid.Column="1"
                                Command="{Binding UpdateOrderCommand}"
                                Content="Update Order"
                                IsEnabled="{Binding UpdateButtonEnabled, UpdateSourceTrigger=PropertyChanged}" />
                        </Grid>
                    </StackPanel>

                    <Grid Margin="10" Visibility="{Binding DeclinedVis, FallbackValue=Visible}">
                        <Rectangle Fill="{StaticResource materialError}" />
                        <TextBlock
                            Padding="10,5"
                            HorizontalAlignment="Center"
                            FontSize="16"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource materialOnError}"
                            Text="Declined" />
                    </Grid>
                    <StackPanel Margin="10,0" Visibility="{Binding DeclinedVis, FallbackValue=Visible}">
                        <TextBlock Foreground="{StaticResource materialError}" Text="Unfortunately this request has been declined, citing the reason below." />
                    </StackPanel>

                    <Separator Margin="0,5" />

                    <StackPanel
                        Grid.Row="2"
                        Margin="10"
                        Visibility="{Binding EditControlsVis, UpdateSourceTrigger=PropertyChanged, Mode=OneWay}">
                        <TextBlock
                            Margin="0,5"
                            Style="{StaticResource section}"
                            Text="Edit Request" />
                        <TextBlock Text="Quantity Required" />
                        <TextBox
                            x:Name="quantityTextbox"
                            IsEnabled="{Binding CanEditRequirements}"
                            Text="{Binding SelectedRequest.QuantityRequired}"
                            Style="{StaticResource UsernameTextBox}"/>

                        <TextBlock Text="Date Required" />
                        <DatePicker
                            DisplayDateStart="{x:Static sys:DateTime.Now}"
                            IsEnabled="{Binding CanEditRequirements}"
                            SelectedDate="{Binding SelectedRequest.DateRequired, Mode=TwoWay}" />

                        <TextBlock Text="Notes" />
                        <Grid>
                            <Border Background="{StaticResource materialSurface}" CornerRadius="10" />
                            <RichTextBox
                                x:Name="notesTextBox"
                                MinHeight="50"
                                Margin="5,10"
                                Background="Transparent"
                                BorderThickness="0">
                                <FlowDocument LineHeight="2" />
                            </RichTextBox>
                        </Grid>

                        <StackPanel HorizontalAlignment="Right" Orientation="Horizontal">
                            <Button
                                x:Name="saveChangesButton"
                                Click="saveChangesButton_Click"
                                Content="Save" />
                        </StackPanel>
                    </StackPanel>
                    <TextBlock Text="{Binding SelectedRequest.Status, StringFormat='{}Status: {0}', FallbackValue='Status: Pending input'}" />
                </StackPanel>

            </Grid>

        </ScrollViewer>
    </Grid>
</UserControl>
