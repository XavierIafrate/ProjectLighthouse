<UserControl
    x:Class="ProjectLighthouse.View.RequestView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:ProjectLighthouse.View"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:uc="clr-namespace:ProjectLighthouse.View.UserControls"
    xmlns:vm="clr-namespace:ProjectLighthouse.ViewModel"
    d:DataContext="{d:DesignInstance Type=vm:RequestViewModel}"
    xmlns:converters="clr-namespace:ProjectLighthouse.ViewModel.ValueConverters"
    Background="{StaticResource materialBackground}"
    mc:Ignorable="d">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="370" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="auto" />
        </Grid.RowDefinitions>


        <ListView
            x:Name="requests_ListView"
            HorizontalContentAlignment="Stretch"
            ItemsSource="{Binding FilteredRequests, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
            ScrollViewer.CanContentScroll="false"
            SelectedItem="{Binding SelectedRequest, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
            SelectionChanged="requests_ListView_SelectionChanged">
            <ListView.ItemTemplate>
                <DataTemplate>
                    <uc:DisplayRequest Margin="10,5" Request="{Binding}" />
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <StatusBar
            Grid.Row="1"
            Margin="10,5"
            HorizontalAlignment="Left"
            Background="Transparent">
            <TextBlock Text="{Binding FilteredRequests.Count, StringFormat='{}{0} request(s)', FallbackValue='10 request(s)'}" />
            <Separator Margin="5,0" Background="LightGray" />
            <TextBlock
                Margin="0,0,10,0"
                VerticalAlignment="Center"
                Text="Filter by:" />
            <ComboBox x:Name="filterComboBox" Text="{Binding SelectedFilter, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                <ComboBoxItem Content="Last 14 Days" IsSelected="True" />
                <ComboBoxItem Content="My Requests" />
                <ComboBoxItem Content="Pending" />
                <ComboBoxItem Content="Accepted" />
                <ComboBoxItem Content="Declined" />
                <ComboBoxItem Content="All" />
            </ComboBox>
            <Button Command="{Binding ExportCommand}" Style="{StaticResource CSVButton}" Margin="0"/>
        </StatusBar>
        <StackPanel Grid.Column="2" VerticalAlignment="Center">
            <TextBlock
                Grid.Column="2"
                HorizontalAlignment="Center"
                FontSize="30"
                Foreground="#dddddd"
                Text="none found :("
                Visibility="{Binding NothingVis, UpdateSourceTrigger=PropertyChanged}" />
            <TextBlock
                Grid.Column="2"
                HorizontalAlignment="Center"
                FontSize="20"
                FontStyle="Italic"
                Foreground="#dddddd"
                Text="try changing the filter"
                Visibility="{Binding NothingVis, UpdateSourceTrigger=PropertyChanged}" />
        </StackPanel>
        <ScrollViewer Grid.RowSpan="2" Grid.Column="2">
            <Grid
                MaxWidth="700"
                Margin="20,10"
                Visibility="{Binding CardVis, UpdateSourceTrigger=PropertyChanged}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Border
                    CornerRadius="10"
                    BorderBrush="{StaticResource materialPrimaryBlue}"
                    BorderThickness="2"/>

                <StackPanel Margin="20">
                    <!--  Card Header  -->
                    <TextBlock Text="{Binding SelectedRequest.Id,StringFormat='{}Request #{0}', FallbackValue='Request #0'}" Style="{StaticResource title}"/>
                    <TextBlock Text="APPROVED" FontWeight="Bold" FontSize="18" Foreground="{StaticResource materialPrimaryGreen}" Visibility="{Binding ApprovedVis}"/>
                    <TextBlock Text="DECLINED" FontWeight="Bold" FontSize="18" Foreground="{StaticResource materialError}" Visibility="{Binding DeclinedVis}"/>
                    <TextBlock Text="PENDING" FontWeight="Bold" FontSize="18" Foreground="{StaticResource materialPrimaryBlue}" Visibility="{Binding ApprovalControlsVis}"/>
                    <!--  MetaData Dates display grid  -->
                    <Separator Margin="0,15,0,5" />
                    <Grid Margin="15,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="auto" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="auto" />
                            <RowDefinition Height="auto" />
                        </Grid.RowDefinitions>
                        <TextBlock FontStyle="Italic" Text="{Binding SelectedRequest.RaisedBy, UpdateSourceTrigger=PropertyChanged, StringFormat='{}Raised by {0}', FallbackValue='Raised by Randy Marsh'}" />
                        <TextBlock
                            Grid.Column="2"
                            HorizontalAlignment="Right"
                            FontStyle="Italic"
                            Text="{Binding SelectedRequest.DateRaised, UpdateSourceTrigger=PropertyChanged, StringFormat='{}{0:dd/MM/yy HH:mm}', FallbackValue='01/01/1970 23:59'}" />

                        <TextBlock
                            Grid.Row="1"
                            FontStyle="Italic"
                            Text="{Binding SelectedRequest.ModifiedBy, UpdateSourceTrigger=PropertyChanged, StringFormat='{}Updated by {0}', FallbackValue='Updated by Kyle Brovloski'}"
                            Visibility="{Binding ModifiedVis, UpdateSourceTrigger=PropertyChanged}" />
                        <TextBlock
                            Grid.Row="1"
                            Grid.Column="2"
                            HorizontalAlignment="Right"
                            FontStyle="Italic"
                            Text="{Binding SelectedRequest.LastModified, UpdateSourceTrigger=PropertyChanged, StringFormat='{}{0:dd/MM/yy HH:mm}', FallbackValue='01/01/1970 23:59'}"
                            Visibility="{Binding ModifiedVis, UpdateSourceTrigger=PropertyChanged}" />
                    </Grid>

                    <!--  Controls area  -->
                    <Separator Margin="0,5" />

                    <StackPanel Margin="10,20,10,20" Visibility="{Binding DecisionVis}">
                        <TextBlock Style="{StaticResource section}" Text="Request Details" />

                        <Grid HorizontalAlignment="Center" Margin="10">
                            <Grid.Resources>
                                <converters:boolToYesNo x:Key="btyn"/>
                            </Grid.Resources>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="auto"/>
                                <RowDefinition Height="auto"/>
                                <RowDefinition Height="auto"/>
                                <RowDefinition Height="auto"/>
                            </Grid.RowDefinitions>
                            <TextBlock VerticalAlignment="Center" Text="Required Product:" Style="{StaticResource annotation}" HorizontalAlignment="Right"/>
                            <TextBlock Padding="0,3,0,0" VerticalAlignment="Center" Text="{Binding SelectedRequest.Product,FallbackValue='REQUIRED_PRODUCT'}" Grid.Column="2" FontWeight="SemiBold"/>

                            <TextBlock VerticalAlignment="Center" Text="Required Quantity:" Style="{StaticResource annotation}" Grid.Row="1" HorizontalAlignment="Right"/>
                            <TextBlock Padding="0,3,0,0" VerticalAlignment="Center" Text="{Binding SelectedRequest.QuantityRequired,FallbackValue='REQUIRED_QUANTITY', StringFormat='{}{0:#,##0}'}" Grid.Column="2" FontWeight="SemiBold" Grid.Row="1"/>
                            
                            <TextBlock VerticalAlignment="Center" Text="Date Required:" Style="{StaticResource annotation}" Grid.Row="2" HorizontalAlignment="Right"/>
                            <TextBlock Padding="0,3,0,0" VerticalAlignment="Center" Grid.Row="2" Text="{Binding SelectedRequest.DateRequired,FallbackValue='DATE_REQUIRED',StringFormat='{}{0:dd MMMM yyyy}'}" Grid.Column="2" FontWeight="SemiBold"/>

                            <TextBlock VerticalAlignment="Center" Text="Ultrasonic Cleaning:" Style="{StaticResource annotation}" Grid.Row="3" HorizontalAlignment="Right"/>
                            <TextBlock Padding="0,3,0,0"  VerticalAlignment="Center" Text="{Binding SelectedRequest.CleanCustomerRequirement,FallbackValue='CLEANING_REQ', Converter={StaticResource btyn}}" Grid.Column="2" FontWeight="SemiBold" Grid.Row="3"/>
                        </Grid>
                        
                        <TextBlock Style="{StaticResource section}" Text="Recommended Manifest" />
                        <Grid Margin="0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock
                                Padding="10,0,0,0"
                                VerticalAlignment="Center"
                                Foreground="{StaticResource materialPrimaryBlue}"
                                Style="{StaticResource statement}"
                                Text="{Binding TargetRuntime, StringFormat='{}Runtime Cap [{0:N0} day(s)]'}" />
                            <TextBlock
                                Grid.Column="1"
                                Padding="10,0"
                                VerticalAlignment="Center"
                                Foreground="{StaticResource materialOnBackground}"
                                Style="{StaticResource statement}"
                                Text="1 day" />
                            <Slider
                                Grid.Column="2"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Center"
                                IsSnapToTickEnabled="True"
                                Maximum="14"
                                Minimum="1"
                                TickPlacement="BottomRight"
                                Value="{Binding TargetRuntime, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock
                                Grid.Column="3"
                                Padding="10,0"
                                VerticalAlignment="Center"
                                Foreground="{StaticResource materialOnBackground}"
                                Style="{StaticResource statement}"
                                Text="14 days" />
                        </Grid>
                        <Grid>
                            <ListView ItemsSource="{Binding RecommendedManifest}">
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <uc:DisplayManifestItem Margin="10,2" Item="{Binding}" />
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                            <Rectangle Fill="#01ffffff" />
                        </Grid>

                        <StackPanel
                            Margin="10,0"
                            HorizontalAlignment="Right"
                            Orientation="Horizontal">
                            <TextBlock
                                VerticalAlignment="Center"
                                FontSize="11"
                                Opacity="0.25"
                                Text="Lighthouse Requests Engine" />
                            <Path
                                Width="12"
                                Height="12"
                                Margin="3,1,0,0"
                                Data="M12 3C7.03 3 3 7.03 3 12S7.03 21 12 21C14 21 15.92 20.34 17.5 19.14L16.06 17.7C14.87 18.54 13.45 19 12 19C8.13 19 5 15.87 5 12S8.13 5 12 5 19 8.13 19 12H16L20 16L24 12H21C21 7.03 16.97 3 12 3M7.71 13.16C7.62 13.23 7.59 13.35 7.64 13.45L8.54 15C8.6 15.12 8.72 15.12 8.82 15.12L9.95 14.67C10.19 14.83 10.44 14.97 10.7 15.09L10.88 16.28C10.9 16.39 11 16.47 11.1 16.47H12.9C13 16.5 13.11 16.41 13.13 16.3L13.31 15.12C13.58 15 13.84 14.85 14.07 14.67L15.19 15.12C15.3 15.16 15.42 15.11 15.47 15L16.37 13.5C16.42 13.38 16.39 13.26 16.31 13.19L15.31 12.45C15.34 12.15 15.34 11.85 15.31 11.55L16.31 10.79C16.4 10.72 16.42 10.61 16.37 10.5L15.47 8.95C15.41 8.85 15.3 8.81 15.19 8.85L14.07 9.3C13.83 9.13 13.57 9 13.3 8.88L13.13 7.69C13.11 7.58 13 7.5 12.9 7.5H11.14C11.04 7.5 10.95 7.57 10.93 7.67L10.76 8.85C10.5 8.97 10.23 9.12 10 9.3L8.85 8.88C8.74 8.84 8.61 8.89 8.56 9L7.65 10.5C7.6 10.62 7.63 10.74 7.71 10.81L8.71 11.55C8.69 11.7 8.69 11.85 8.71 12C8.7 12.15 8.7 12.3 8.71 12.45L7.71 13.19M12 13.5H12C11.16 13.5 10.5 12.82 10.5 12C10.5 11.17 11.17 10.5 12 10.5S13.5 11.17 13.5 12 12.83 13.5 12 13.5"
                                Fill="Black"
                                Opacity="0.25"
                                Stretch="Uniform" />
                        </StackPanel>

                        <TextBlock
                            Grid.Row="2"
                            Margin="0,10,0,5"
                            HorizontalAlignment="Center"
                            FontStyle="Italic"
                            Text="Reason for declining:"
                            Visibility="{Binding ApprovalControlsVis}" />
                        <ComboBox
                            x:Name="DeclineComboBox"
                            MaxWidth="300"
                            Margin="0,0,0,5"
                            IsEnabled="{Binding DropboxEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            Text="{Binding SelectedRequest.DeclinedReason, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                            Visibility="{Binding ApprovalControlsVis}">
                            <ComboBoxItem Content="Uneconomical" />
                            <ComboBoxItem Content="No active requirement" />
                            <ComboBoxItem Content="Cannot deliver on time" />
                            <ComboBoxItem Content="Machining not possible" />
                            <ComboBoxItem Content="Duplicate request" />
                            <ComboBoxItem Content="Merged with active order" />
                        </ComboBox>

                        <Grid
                            x:Name="approvalControls"
                            Margin="0,20"
                            HorizontalAlignment="Center"
                            Visibility="{Binding ApprovalControlsVis}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition Width="auto" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="auto" />
                                <RowDefinition Height="5" />
                                <RowDefinition Height="auto" />
                                <RowDefinition Height="auto" />
                            </Grid.RowDefinitions>
                            <Button
                                x:Name="DeclineButton"
                                Margin="10,0"
                                Command="{Binding DeclineCommand}"
                                Style="{StaticResource DeclineButton}" />
                            <Button
                                x:Name="ApproveButton"
                                Grid.Column="1"
                                Margin="10,0"
                                Command="{Binding ApproveCommand}"
                                Style="{StaticResource ApproveButton}" />

                        </Grid>
                    </StackPanel>
                    <Grid Margin="10" Visibility="{Binding ApprovedVis, FallbackValue=Visible}">
                        <Rectangle Fill="{StaticResource materialPrimaryGreen}" />
                        <TextBlock
                            Padding="10,5"
                            HorizontalAlignment="Center"
                            FontSize="16"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource materialOnPrimary}"
                            Text="Approved" />
                    </Grid>

                    <StackPanel Margin="10,0" Visibility="{Binding ApprovedVis, FallbackValue=Visible}">
                        <TextBlock Text="{Binding SelectedRequest.ResultingLMO,StringFormat='{}This request was approved for manufacture and is on order {0}'}" Style="{StaticResource annotation}" />
                        <TextBlock Padding="0,5,0,4" Text="Please update the Purchase Order reference:" Style="{StaticResource annotation}" />
                        <TextBox Style="{StaticResource UsernameTextBox}" Text="{Binding PurchaseRef, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="auto" />
                            </Grid.ColumnDefinitions>
                            <Button
                                Grid.Column="1"
                                Command="{Binding UpdateOrderCommand}"
                                Content="Update Order"
                                IsEnabled="{Binding UpdateButtonEnabled, UpdateSourceTrigger=PropertyChanged}" />
                        </Grid>
                    </StackPanel>

                    <Grid Margin="10" Visibility="{Binding DeclinedVis, FallbackValue=Visible}">
                        <Rectangle Fill="{StaticResource materialError}" />
                        <TextBlock
                            Padding="10,5"
                            HorizontalAlignment="Center"
                            FontSize="16"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource materialOnError}"
                            Text="Declined" />
                    </Grid>
                    <StackPanel Margin="10,0" Visibility="{Binding DeclinedVis, FallbackValue=Visible}">
                        <TextBlock HorizontalAlignment="Center" Text="Unfortunately this request has been declined." Style="{StaticResource annotation}" />
                    </StackPanel>

                    <Separator Margin="0,5" />

                    <StackPanel
                        Grid.Row="2"
                        Margin="10"
                        Visibility="{Binding EditControlsVis, UpdateSourceTrigger=PropertyChanged, Mode=OneWay}">
                        <TextBlock
                            Margin="0,5"
                            Style="{StaticResource section}"
                            Text="Edit Request" />
                        <Grid Margin="10">
                            <TextBox
                                x:Name="quantityTextbox"
                                Margin="0"
                                IsEnabled="{Binding CanEditRequirements}"
                                Style="{StaticResource DefaultTextBox}"
                                Tag="Quantity Required"
                                Text="{Binding SelectedRequest.QuantityRequired, UpdateSourceTrigger=PropertyChanged}" />
                        </Grid>

                        <Grid Margin="10">
                            <DatePicker
                                x:Name="EditDate_DatePicker"
                                DisplayDateStart="{x:Static sys:DateTime.Now}"
                                IsEnabled="{Binding CanEditRequirements}"
                                SelectedDate="{Binding SelectedRequest.DateRequired, Mode=TwoWay}" />
                        </Grid>

                        <CheckBox
                            HorizontalAlignment="Right"
                            Margin="5,0"
                            Content="Ultrasonic cleaning is required"
                            FontWeight="Medium"
                            IsChecked="{Binding SelectedRequest.CleanCustomerRequirement, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            IsEnabled="{Binding CanEditRequirements}" />


                        <TextBlock Style="{StaticResource section}" Text="Notes" />
                        <Grid Margin="10">
                            <Border Background="{StaticResource materialSurface}" CornerRadius="10" />
                            <RichTextBox
                                x:Name="notesTextBox"
                                MinHeight="50"
                                Margin="5,10"
                                Background="Transparent"
                                BorderThickness="0">
                                <FlowDocument LineHeight="2" />
                            </RichTextBox>
                        </Grid>

                        <StackPanel HorizontalAlignment="Right" Orientation="Horizontal">
                            <Button
                                x:Name="saveChangesButton"
                                Click="saveChangesButton_Click"
                                Content="Save" />
                        </StackPanel>
                    </StackPanel>
                    <!--<TextBlock Text="{Binding SelectedRequest.Status, StringFormat='{}Status: {0}', FallbackValue='Status: Pending input'}" />-->
                </StackPanel>

            </Grid>

        </ScrollViewer>
    </Grid>
</UserControl>
